<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <title data-i18n="title">拍照识别饮食 - 今日</title>
  <link rel="stylesheet" href="./style.css" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4VFTHNYWQ7"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-4VFTHNYWQ7');
  </script>
</head>
<body>
  <header class="topbar">
    <div class="topbar__title">
      <div class="brand">FoodSnap</div>
      <div class="subtitle" id="todayLabel" data-i18n="today">今日</div>
    </div>
    <div class="topbar__actions">
      <button class="lang-btn" id="langToggle" title="Switch Language">EN</button>
      <a class="icon-btn" href="./dashboard.html" aria-label="统计">
        <span class="icon">📊</span>
      </a>
      <button class="icon-btn" id="userBtn" aria-label="登录/用户">
        <span class="icon" id="userIcon">👤</span>
      </button>
    </div>
  </header>

  <main class="container">
    <!-- 目标/进度 -->
    <section class="card">
      <div class="card__header">
        <h2 class="card__title" data-i18n="todayProgress">今日进度</h2>
        <button class="text-btn" id="openProfileBtn" data-i18n="goalSettings">目标设置</button>
      </div>

      <div class="kpi">
        <div class="kpi__row">
          <div class="kpi__label" data-i18n="calories">热量</div>
          <div class="kpi__value"><span id="kcalNow">0</span> / <span id="kcalGoal">2000</span> kcal</div>
        </div>
        <div class="progress">
          <div class="progress__bar" id="kcalBar" style="width:0%"></div>
        </div>

        <div class="macro-grid">
          <div class="macro">
            <div class="macro__head">
              <span data-i18n="protein">蛋白</span>
              <span><b id="pNow">0</b>/<span id="pGoal">120</span>g</span>
            </div>
            <div class="progress progress--sm"><div class="progress__bar" id="pBar" style="width:0%"></div></div>
          </div>
          <div class="macro">
            <div class="macro__head">
              <span data-i18n="carbs">碳水</span>
              <span><b id="cNow">0</b>/<span id="cGoal">220</span>g</span>
            </div>
            <div class="progress progress--sm"><div class="progress__bar" id="cBar" style="width:0%"></div></div>
          </div>
          <div class="macro">
            <div class="macro__head">
              <span data-i18n="fat">脂肪</span>
              <span><b id="fNow">0</b>/<span id="fGoal">60</span>g</span>
            </div>
            <div class="progress progress--sm"><div class="progress__bar" id="fBar" style="width:0%"></div></div>
          </div>
        </div>

        <!-- Exercise/Activity Row -->
        <div class="exercise-row" id="exerciseRow">
          <div class="exercise-info">
            <span class="exercise-icon">🏃</span>
            <span class="exercise-label" data-i18n="exercise">运动</span>
            <span class="exercise-value"><span id="exerciseKcal">0</span> kcal <span data-i18n="exerciseBurned">消耗</span></span>
          </div>
          <div class="net-cal">
            <span data-i18n="netCalories">净摄入</span>: <b id="netKcal">0</b> kcal
          </div>
          <button class="text-btn" id="addExerciseBtn" data-i18n="addExercise">添加运动</button>
        </div>

        <div class="advice" id="adviceCard">
          <div class="advice__title" data-i18n="advice">建议</div>
          <div class="advice__text" id="adviceText" data-i18n="setGoalHint">设置目标后，将给出可执行建议。</div>
        </div>
      </div>
    </section>

    <!-- 今日记录 -->
    <section class="card">
      <div class="card__header">
        <h2 class="card__title" data-i18n="todayRecords">今日记录</h2>
        <button class="text-btn danger" id="clearTodayBtn" data-i18n="clearToday">清空今日</button>
      </div>
      <div id="todayList" class="meal-list"></div>
      <div class="empty" id="todayEmpty" hidden data-i18n="noRecords">
        还没有记录。点击下方"拍照记录"开始。
      </div>
    </section>
  </main>

  <!-- 悬浮拍照按钮 -->
  <div class="fab-wrap">
    <button class="fab" id="openCaptureBtn" data-i18n="snapMeal">拍照记录</button>
  </div>

  <!-- 拍照/上传弹层 -->
  <div class="sheet" id="captureSheet" aria-hidden="true">
    <div class="sheet__mask" data-close="1"></div>
    <div class="sheet__panel">
      <div class="sheet__title" data-i18n="photoUpload">拍照/上传</div>
      <div class="sheet__body">
        <div class="btn-row">
          <label class="btn btn--primary">
            <input id="cameraInput" type="file" accept="image/*" capture="environment" hidden />
            <span data-i18n="openCamera">打开相机</span>
          </label>
          <label class="btn">
            <input id="albumInput" type="file" accept="image/*" hidden />
            <span data-i18n="fromAlbum">从相册选择</span>
          </label>
        </div>

        <div class="hint" data-i18n="compressHint">
          图片会在本地压缩后再上传识别。
        </div>

        <div class="preview" id="previewWrap" hidden>
          <img id="previewImg" alt="预览" />
          <div class="preview__meta">
            <div class="seg">
              <label class="seg__label" data-i18n="mealType">餐次</label>
              <select id="mealTypeSelect" class="select">
                <option value="breakfast" data-i18n="breakfast">早餐</option>
                <option value="lunch" selected data-i18n="lunch">午餐</option>
                <option value="dinner" data-i18n="dinner">晚餐</option>
                <option value="snack" data-i18n="snack">加餐</option>
              </select>
            </div>
            <button class="btn btn--primary" id="analyzeBtn" data-i18n="startAnalyze">开始识别</button>
          </div>
        </div>

        <div class="loading" id="loadingBox" hidden>
          <div class="spinner"></div>
          <div class="loading__text" id="loadingText" data-i18n="analyzing">识别中…</div>
        </div>
      </div>
      <div class="sheet__footer">
        <button class="btn btn--ghost" data-close="1" data-i18n="close">关闭</button>
      </div>
    </div>
  </div>

  <!-- 识别结果页（同页弹层） -->
  <div class="sheet" id="resultSheet" aria-hidden="true">
    <div class="sheet__mask" data-close="1"></div>
    <div class="sheet__panel sheet__panel--full">
      <div class="sheet__title" data-i18n="confirmResult">识别确认</div>
      <div class="sheet__body">
        <div class="result-head">
          <img id="resultImg" class="result-img" alt="结果图片" />
          <div class="result-sum">
            <div class="sum-kpi">
              <div class="sum-kpi__label" data-i18n="mealCalories">本餐热量</div>
              <div class="sum-kpi__value"><span id="mealKcal">0</span> kcal</div>
            </div>
            <div class="sum-macros">
              <span>P <b id="mealP">0</b>g</span>
              <span>C <b id="mealC">0</b>g</span>
              <span>F <b id="mealF">0</b>g</span>
            </div>
          </div>
        </div>

        <div class="card card--flat">
          <div class="card__header">
            <h3 class="card__title" data-i18n="foodList">食物列表</h3>
            <button class="text-btn" id="addManualBtn" data-i18n="addManual">手动添加</button>
          </div>
          <div id="foodList" class="food-list"></div>
          <div class="hint" data-i18n="adjustHint">可拖动滑杆调整份量（g），营养会自动更新。</div>
        </div>

        <div class="card card--flat">
          <div class="card__header">
            <h3 class="card__title" data-i18n="saveTo">保存到</h3>
          </div>
          <div class="btn-row">
            <button class="btn" data-meal="breakfast" data-i18n="breakfast">早餐</button>
            <button class="btn" data-meal="lunch" data-i18n="lunch">午餐</button>
            <button class="btn" data-meal="dinner" data-i18n="dinner">晚餐</button>
            <button class="btn" data-meal="snack" data-i18n="snack">加餐</button>
          </div>
        </div>
      </div>

      <div class="sheet__footer">
        <button class="btn btn--ghost" id="retakeBtn">重拍</button>
        <button class="btn btn--ghost" data-close="1" data-i18n="back">返回</button>
      </div>
    </div>
  </div>

  <!-- 运动输入弹层 -->
  <div class="sheet" id="exerciseSheet" aria-hidden="true">
    <div class="sheet__mask" data-close="1"></div>
    <div class="sheet__panel">
      <div class="sheet__title" data-i18n="exerciseInput">运动输入</div>
      <div class="sheet__body">
        <div class="form">
          <label class="field">
            <span class="field__label" data-i18n="exerciseKcal">运动消耗</span>
            <div class="input-group">
              <input id="exerciseKcalInput" class="input" type="number" inputmode="numeric" min="0" max="5000" value="0" />
              <span class="input-suffix">kcal</span>
            </div>
          </label>

          <label class="field">
            <span class="field__label" data-i18n="steps">步数</span>
            <input id="stepsInput" class="input" type="number" inputmode="numeric" min="0" max="100000" value="0" />
          </label>

          <label class="field">
            <span class="field__label" data-i18n="activeMinutes">活动时长</span>
            <div class="input-group">
              <input id="activeMinutesInput" class="input" type="number" inputmode="numeric" min="0" max="1440" value="0" />
              <span class="input-suffix">min</span>
            </div>
          </label>

          <div class="hint" data-i18n="exerciseHint">输入运动数据以计算净热量摄入。</div>
        </div>
      </div>
      <div class="sheet__footer">
        <button class="btn btn--ghost" data-close="1" data-i18n="cancel">取消</button>
        <button class="btn btn--primary" id="saveExerciseBtn" data-i18n="save">保存</button>
      </div>
    </div>
  </div>

  <!-- 目标设置弹层 -->
  <div class="sheet" id="profileSheet" aria-hidden="true">
    <div class="sheet__mask" data-close="1"></div>
    <div class="sheet__panel">
      <div class="sheet__title">目标设置（简化版）</div>
      <div class="sheet__body">
        <div class="form">
          <label class="field">
            <span class="field__label">目标</span>
            <select id="goalType" class="select">
              <option value="cut">减脂</option>
              <option value="bulk">增肌</option>
              <option value="maintain" selected>健康维持</option>
            </select>
          </label>

          <div class="grid2">
            <label class="field">
              <span class="field__label">性别</span>
              <select id="sex" class="select">
                <option value="male" selected>男</option>
                <option value="female">女</option>
              </select>
            </label>
            <label class="field">
              <span class="field__label">年龄</span>
              <input id="age" class="input" type="number" inputmode="numeric" min="10" max="90" value="28" />
            </label>
          </div>

          <div class="grid2">
            <label class="field">
              <span class="field__label">身高(cm)</span>
              <input id="height" class="input" type="number" inputmode="numeric" min="120" max="220" value="175" />
            </label>
            <label class="field">
              <span class="field__label">体重(kg)</span>
              <input id="weight" class="input" type="number" inputmode="decimal" min="35" max="200" value="70" />
            </label>
          </div>

          <label class="field">
            <span class="field__label">活动水平</span>
            <select id="activity" class="select">
              <option value="1.2">久坐</option>
              <option value="1.375" selected>轻度活动</option>
              <option value="1.55">中度活动</option>
              <option value="1.725">高强度</option>
            </select>
          </label>

          <div class="hint">将用 Mifflin-St Jeor + 活动系数估算 TDEE，并按目标分配 P/C/F。</div>
        </div>
      </div>
      <div class="sheet__footer">
        <button class="btn btn--ghost" data-close="1">取消</button>
        <button class="btn btn--primary" id="saveProfileBtn">保存</button>
      </div>
    </div>
  </div>

  <!-- 登录/用户弹层 -->
  <div class="sheet" id="authSheet" aria-hidden="true">
    <div class="sheet__mask" data-close="1"></div>
    <div class="sheet__panel">
      <div class="sheet__title" id="authSheetTitle" data-i18n="login">登录</div>
      <div class="sheet__body">
        <!-- 未登录状态 -->
        <div id="loginView">
          <div class="auth-intro">
            <p data-i18n="loginBenefit">登录后，您的数据将安全保存在云端，可在多设备间同步。</p>
          </div>
          <div class="auth-buttons">
            <button class="btn auth-btn auth-btn--google" id="googleSignInBtn">
              <svg class="auth-icon" viewBox="0 0 24 24" width="20" height="20">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              <span data-i18n="signInWithGoogle">使用 Google 登录</span>
            </button>
            <button class="btn auth-btn auth-btn--apple" id="appleSignInBtn">
              <svg class="auth-icon" viewBox="0 0 24 24" width="20" height="20">
                <path fill="currentColor" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
              </svg>
              <span data-i18n="signInWithApple">使用 Apple 登录</span>
            </button>
          </div>
          <div class="hint" data-i18n="loginPrivacy">我们不会公开您的个人信息。</div>
        </div>

        <!-- 已登录状态 -->
        <div id="userView" hidden>
          <div class="user-profile">
            <img id="userAvatar" class="user-avatar" src="" alt="头像" />
            <div class="user-info">
              <div class="user-name" id="userName">用户名</div>
              <div class="user-email" id="userEmail">email@example.com</div>
            </div>
          </div>
          <div class="user-stats">
            <div class="user-stat">
              <span class="user-stat__label" data-i18n="provider">登录方式</span>
              <span class="user-stat__value" id="userProvider">Google</span>
            </div>
            <div class="user-stat">
              <span class="user-stat__label" data-i18n="memberSince">注册时间</span>
              <span class="user-stat__value" id="userSince">-</span>
            </div>
          </div>
          <button class="btn btn--ghost danger" id="logoutBtn" data-i18n="logout">退出登录</button>
        </div>
      </div>
      <div class="sheet__footer">
        <button class="btn btn--ghost" data-close="1" data-i18n="close">关闭</button>
      </div>
    </div>
  </div>

  <!-- Google Sign-In SDK -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script src="./app.js"></script>
</body>
</html>